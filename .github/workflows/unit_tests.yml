name: Unit tests

permissions:
  contents: read

on:
  workflow_call:
    inputs:
      linux_6_0_enabled:
        type: boolean
        description: "Boolean to enable the Linux 6.0 Swift version matrix job. Defaults to true."
        default: true
      linux_6_0_arguments_override:
        type: string
        description: "The arguments passed to swift test in the Linux 6.0 Swift version matrix job."
        default: ""
      linux_6_1_enabled:
        type: boolean
        description: "Boolean to enable the Linux 6.1 Swift version matrix job. Defaults to true."
        default: true
      linux_6_1_arguments_override:
        type: string
        description: "The arguments passed to swift test in the Linux 6.1 Swift version matrix job."
        default: ""
      linux_6_2_enabled:
        type: boolean
        description: "Boolean to enable the Linux 6.2 Swift version matrix job. Defaults to true."
        default: true
      linux_6_2_arguments_override:
        type: string
        description: "The arguments passed to swift test in the Linux 6.2 Swift version matrix job."
        default: ""
      linux_nightly_next_enabled:
        type: boolean
        description: "Boolean to enable the Linux nightly next Swift version matrix job. Defaults to true."
        default: true
      linux_nightly_next_arguments_override:
        type: string
        description: "The arguments passed to swift test in the Linux nightly next Swift version matrix job."
        default: ""
      linux_nightly_main_enabled:
        type: boolean
        description: "Boolean to enable the Linux nightly main Swift version matrix job. Defaults to true."
        default: true
      linux_nightly_main_arguments_override:
        type: string
        description: "The arguments passed to swift test in the Linux nightly main Swift version matrix job."
        default: ""

jobs:
  unit-tests:
    name: Unit tests (${{ matrix.swift.swift_version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # We are specifying only the major and minor of the docker images to automatically pick up the latest patch release
        swift:
          - image: "swift:6.0-jammy"
            swift_version: "6.0"
            enabled: ${{ inputs.linux_6_0_enabled }}
          - image: "swift:6.1-jammy"
            swift_version: "6.1"
            enabled: ${{ inputs.linux_6_1_enabled }}
          - image: "swift:6.2-jammy"
            swift_version: "6.2"
            enabled: ${{ inputs.linux_6_2_enabled }}
          - image: "swiftlang/swift:nightly-6.3-jammy"
            swift_version: "nightly-next"
            enabled: ${{ inputs.linux_nightly_next_enabled }}
          - image: "swiftlang/swift:nightly-main-jammy"
            swift_version: "nightly-main"
            enabled: ${{ inputs.linux_nightly_main_enabled }}
    steps:
      - name: Checkout repository
        if: ${{ matrix.swift.enabled }}
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          submodules: true
      - name: Mark the workspace as safe
        if: ${{ matrix.swift.enabled }}
        # https://github.com/actions/checkout/issues/766
        run: git config --global --add safe.directory ${GITHUB_WORKSPACE}
      - name: Run matrix job
        if: ${{ matrix.swift.enabled }}
        env:
          SWIFT_VERSION: ${{ matrix.swift.swift_version }}
          COMMAND: "swift test"
          COMMAND_OVERRIDE_6_0: "swift test ${{ inputs.linux_6_0_arguments_override }}"
          COMMAND_OVERRIDE_6_1: "swift test ${{ inputs.linux_6_1_arguments_override }}"
          COMMAND_OVERRIDE_6_2: "swift test ${{ inputs.linux_6_2_arguments_override }}"
          COMMAND_OVERRIDE_NIGHTLY_NEXT: "swift test ${{ inputs.linux_nightly_next_arguments_override }}"
          COMMAND_OVERRIDE_NIGHTLY_MAIN: "swift test ${{ inputs.linux_nightly_main_arguments_override }}"
        run: |
          apt-get -qq update && apt-get -qq -y install curl && apt-get -y install libsasl2-dev libssl-dev
          curl -s https://raw.githubusercontent.com/apple/swift-nio/main/scripts/check-matrix-job.sh | bash
    container:
      image: ${{ matrix.swift.image }}
    env:
      KAFKA_HOST: kafka
    services:
      kafka:
        image: apache/kafka:3.9.1
        env:
          KAFKA_NODE_ID: 1
          KAFKA_PROCESS_ROLES: "broker,controller"
          KAFKA_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093"
          KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:9092"
          KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
          KAFKA_CONTROLLER_QUORUM_VOTERS: "1@localhost:9093"
          KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT"
          KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
          KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
          KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
          KAFKA_SHARE_COORDINATOR_STATE_TOPIC_REPLICATION_FACTOR: 1
          KAFKA_SHARE_COORDINATOR_STATE_TOPIC_MIN_ISR: 1
          KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
